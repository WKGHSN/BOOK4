import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../../models/book.dart';
import '../../constants/app_colors.dart';

class ReaderScreen extends StatefulWidget {
  final Book book;

  const ReaderScreen({super.key, required this.book});

  @override
  State<ReaderScreen> createState() => _ReaderScreenState();
}

class _ReaderScreenState extends State<ReaderScreen> {
  bool _isDarkMode = false;
  double _fontSize = 16.0;
  ScrollController? _scrollController;
  double _progress = 0.0;
  bool _showControls = true;

  @override
  void initState() {
    super.initState();
    _scrollController = ScrollController();
    _scrollController!.addListener(_updateProgress);
    _loadSettings();
  }

  @override
  void dispose() {
    _scrollController?.dispose();
    super.dispose();
  }

  Future<void> _loadSettings() async {
    final prefs = await SharedPreferences.getInstance();
    setState(() {
      _isDarkMode = prefs.getBool('reader_dark_mode') ?? false;
      _fontSize = prefs.getDouble('reader_font_size') ?? 16.0;
      _progress = prefs.getDouble('book_progress_${widget.book.id}') ?? 0.0;
    });
    
    // Відновлення позиції прокрутки
    if (_progress > 0 && _scrollController!.hasClients) {
      _scrollController!.jumpTo(_progress * _scrollController!.position.maxScrollExtent);
    }
  }

  Future<void> _saveSettings() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('reader_dark_mode', _isDarkMode);
    await prefs.setDouble('reader_font_size', _fontSize);
    await prefs.setDouble('book_progress_${widget.book.id}', _progress);
  }

  void _updateProgress() {
    if (_scrollController!.hasClients) {
      final maxScroll = _scrollController!.position.maxScrollExtent;
      final currentScroll = _scrollController!.position.pixels;
      if (maxScroll > 0) {
        setState(() {
          _progress = currentScroll / maxScroll;
        });
        _saveSettings();
      }
    }
  }

  void _toggleDarkMode() {
    setState(() {
      _isDarkMode = !_isDarkMode;
    });
    _saveSettings();
  }

  void _changeFontSize(bool increase) {
    setState(() {
      if (increase && _fontSize < 24) {
        _fontSize += 2;
      } else if (!increase && _fontSize > 12) {
        _fontSize -= 2;
      }
    });
    _saveSettings();
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
    });
  }

  // Демо-текст для читання (оскільки файли не завантажені)
  String _getDemoText() {
    return '''
${widget.book.title}
Автор: ${widget.book.author}

${widget.book.description}

Частина 1. Факти

1. Важлива персона в "Таврському Експресі"

Це трапилося о п'ятій годині зимового ранку в Сирії. Поблизу платформи в Алеппо стояв потяг з величною назвою "Таврський Експрес". До його складу входили: кухня, вагон-ресторан, спальний вагон та два вагони місцевого значення.

При вході у спальний вагон стояв молодий французький лейтенант у блискучій формі, що розмовляв із невеликим на зріст чоловічком, який був закутаний по самі вуха у шарф, з-під якого стирчали рожевий ніс і закручені вусики.

Було надзвичайно морозно, і хоча роботі супровожувати кожного пасажира не позаздриш, лейтенант Дюбош виконував її доволі мужньо. Приємні слова з його вуст лунали витонченою французькою мовою. Хоча загалом він не розумів, що коїться. Ходило чимало пліток, як і зазвичай в таких випадках. Його генерал ставав все суворіший й суворіший. Ще й цей бельгієць з'явився – напевне, з Англії прибув. Попередній тиждень був надзвичайно дивним – коїлися абсолютно незрозумілі речі. Один із відданих офіцерів вчинив самогубство, інший – подав у відставку. Згодом усе заспокоїлося. І генерал, командир лейтенанта Дюбоша, наче літ на десять помолодшав.

Лейтенант випадково почув частку розмови між генералом та незнайомцем. "Ви врятували нас, друже", – сказав генерал з певною тривогою, його білі вуса тремтіли. "Ви врятували честь армії Франції – відвернули страшне кровопролиття. Дякую, що погодилися на мою пропозицію приїхати в таку далечінь…" . На що незнайомець (його ім'я було Еркюль Пуаро) зазначив – "Що ви, хіба я міг забути, що ви мені раніше врятували життя?" Генерал висловився, що його заслуги його перебільшені, і їхня розмова продовжилася в звичайному дусі, де можна було почути слова Франція, Бельгія, честь, повага та інші. Згодом вони обійнялися та розпрощалися. Про що йшла мова, лейтенант Дюбош так і не зрозумів, але доручення провести Пуаро на "Таврський Експрес" було покладене на нього, тому з великою завзятістю молодий багатообіцяючий офіцер взявся за нього.

– Сьогодні неділя, – сказав лейтенант. – Завтра, в понеділок, ви будете у Стамбулі.

Це вже не вперше він говорив цю звичну фразу. Розмови на платформі, перед відправкою потяга, завжди в чомусь подібні між собою.

– Так, – погодився Пуаро.

– Ви, напевне, затримаєтеся там на декілька днів?

– Так, звісно. Я ще не бував у Стамбулі. Було би дуже жаль проминути його, ось, – він клацнув пальцями, – Я не маю нагальних справ і можу декілька днів погуляти.

– Свята Софія, надзвичайно прекрасна, – сказав Дюбош, який жодного разу її не бачив.

Здійнявся прохолодний вітер і обоє чоловіків здригнулися. Дюбош поглянув на свій годинник. За п'ять п'ята – залишилося лише п'ять хвилин! Думаючи, що незнайомець спіймав його погляд, він поспіхом продовжив розмову.– Лише декілька людей подорожують в таку пору року, – поглянувши у вікна спального вагона, мовив Дюбош.

– Так, – погодився з ним Пуаро.

– Сподіваюся, вас не занесе снігом десь у Таврських горах!

– Таке буває?

– О, так! На щастя, в цьому році таких випадків не траплялося.

– Будемо сподіватися, – відповів Пуаро. – Проте погодні вісті з Європи, на жаль, невтішні.

– Дуже. На Балканах повно снігу.

– У Німеччині теж. Я чув.

– Ну, – сказав лейтенант Дюбош, стараючись заповнити паузу, – Завтра, о сьомій сорок ви будете в Константинополі.

– Так, – мовив Пуаро, і додав, – Чув, що Свята Софія прекрасна.

– Думаю, вона розкішна.

Понад їхніми головами розсунулися штори, і з-за них виглянула молода жінка.

Мері Дебенхем практично не спала після від'їзду з Багдада минулого четверга. Ані в поїзді до Кіркука, ані в кімнаті для відпочинку в Мосулі, минулої ночі теж їй не вдалося відпочити. Стомившись від лежання в душному купе, вона споглядала у вікно.

Напевне, це Алеппо. Нічого особливого. Довга, погано освітлена платформа з гучномовцем, позаду арабською хтось сперечався. Під її вікном балакають французькою. Один із них французький офіцер, інший – коротун із дивними вусиками. Вона посміхнулася, бо ніколи не бачила такого закутаного чоловіка. Надворі, здається, дуже холодно. Ось чому у вагоні так сильно обігрівають. Вона спробувала опустити вікно нижче. Але їй це не вдалося.

Провідник підійшов до чоловіків. Він сказав, що потяг відправляється і що мсьє повинен зайняти місце у вагоні. Маленький чоловік зняв капелюха. Голова – точнісінько як яйце! Незважаючи на всі клопоти, Мері Дебенхем посміхнулася. Таких коротунів ніхто не сприймає всерйоз.

Лейтенант Дюбош висловив напутню промову. Він її підготував завчасно та зберігав до останньої хвилини. Вона була блискучою.

Намагаючись не відстати, Пуаро відповів тим самим.

– Поїзд відправляється, – сказав провідник. І з великим небажанням у погляді Пуаро зайшов у вагон. Провідник прослідував за ним. Лейтенант Дюбош відсалютував, і потяг, рушивши з місця, почав повільно рухатися.

– Нарешті, – промимрив Пуаро.

– Бррррр, – сказав лейтенант Дюбош, зрозумівши, що дуже змерз.

– Ось, мсьє. – Провідник провів Пуаро і, дуже жестикулюючи, показав йому всю чарівність і чистоту купе. – Дозвольте вашу валізу. Я її поставлю тут. Він простягнув руку з певним наміром. Еркюль Пуаро вклав у неї декілька складених банкнот.

– Дякую, мсьє. – Провідник оживився. – Ваші квитки у мене. Дозвольте ваш паспорт? Ви їдете до Стамбула, так?

Пуаро простягнув документ. – Зараз небагато людей їде, так? – Ні, сер, лише двоє пасажирів – обоє англійці. Полковник із Індії та молода леді з Багдада. Чогось бажаєте? – Пляшку "Пер'є".

П'ята година ранку – не кращий час для посадки. Залишається лише 2 години до світанку. Зрештою, Пуаро з відчуттям завершеної справи згорнувся в кутку й заснув. Прокинувшись о пів на десяту, він вирушив до вагона-ресторану за чашкою гарячої кави. Там він побачив лише молоду леді, яка щось пояснювала провіднику. Висока, худа, темноволоса – приблизно двадцять вісім років. Щось у ній було дивовижне – вона снідала, підкликала офіціанта, щоб він долив їй кави та розповідала про модний одяг, світ та подорожі. Одягнута вона була в темну сукню з тоненької тканини. Пуаро не знайшов для себе нічого цікавішого, аніж непомітно спостерігати за нею.

Це була молода, стримана та врівноважена леді, яка зможе про себе подбати в будь-якій ситуації. Йому дуже сподобалася виразність її рис обличчя, вишукане вбрання, темне звивисте волосся та очі – сірі, холоднокровні, ніби вдивляються в нікуди. Проте Пуаро зауважив, що вона з тих жінок, яких він називає "красива жінка".

Згодом у вагон-ресторан увійшов високий худий чоловік, на вигляд сорока-п'ятдесяти років, у коричневому костюмі, з легкою сивиною на скронях.

– Полковник з Індії, – промовив до себе Пуаро.

Зайшовши в кімнату, незнайомець вклонився дівчині. – Доброго ранку, міс Дебенхем. – Доброго, полковнику Арбетнот.

Полковник стояв навпроти неї, опершись на стілець.

– Щось не так?

– Ні, все гаразд. Сідайте.

– Сніданок – не найкращий час для розмов.

– Я не кусаюся.

Полковник сів і покликав офіціанта як справжній офіцер, замовивши каву та яєчню. Погляд його ненадовго зупинився на Еркюлеві Пуаро, який прочитав у його очах фразу "Дивакуватий іноземець".

Як і всі англійці, вони не були балакучими. Обмінявшись декількома сухими фразами і подарувавши дівчині троянду вони пішли в її купе.

Під час обіду вони знову сиділи за одним столиком, ігноруючи третього пасажира. Розмовляли вони значно жвавіше, ніж уранці. Полковник розповідав про Пенджаб, іноді розпитуючи дівчину про Багдад, де вона була гувернанткою. Під час розмови в них виявилося декілька спільних знайомих, що відразу зблизило їхні стосунки. Говорили про старого Томмі, старого Реджі та інших людей. Полковник поцікавився, чи їде вона далі до Англії чи зупиняється в Стамбулі. – Їду далі. – Не хочете побачити місто? – Два роки тому я їхала цією дорогою і три дні провела в Стамбулі. – Зрозуміло. Мушу зізнатися, я щасливий, адже я також їду до Англії.

Він незграбно вклонився і на його обличчі з'явився рум'янець.

– Він чутливий, цей полковник, – подумав Пуаро з посмішкою. – Подорож потягом більш небезпечна, ніж морем.

Міс Дебенхем спокійно відповіла, що це чудово. Її манери були дещо жорсткими. Пуаро зазначив, що полковник провів її до купе. Вони споглядали мальовничі краєвиди Таврських гір. Під ними проходили Кілікійські Ворота, коли вони зупинилися в коридорі. Пуаро якраз проходив повз, коли дівчина прошепотіла:

– Як прекрасно! Я, я…

– Що?

– Я просто в захваті!

Арбенот не відповів, але його обличчя дещо похмурніло. Він сказав:

– Хочу, щоб ви усе це покинули.

– Тихіше, будь ласка.

– О, звісно! – Він кинув презирливий погляд на Пуаро. – Проте мені не подобається ваша робота гувернанткою. Бути на побігеньках у тиранів-матусь та їхніх набридливих малюків.

Дівчина посміхнулася широкою посмішкою:

– Не думайте про це. Зневажливе ставлення до гувернанток – лише вигадки. Можете бути певні, що іноді навіть батьки мене побоюються.

Арбетнот виглядав присоромленим.

– Якусь цікаву комедію бачу я зараз, – задумався Пуаро і згадав, що раніше думав про те ж саме.

Вони прибули до Коньї о пів на дванадцяту ночі. Англійські пасажири вийшли розім'яти ноги, крокуючи вперед і назад по засніженій платформі.

Пуаро вирішив поглянути на станцію з вікна. За десять хвилин він все ж таки вирішив вийти й подихати свіжим повітрям. Він одягнув на себе декілька кофтин і міцно закутався, а також взув свої черевики в калоші. Одягнувшись, він обережно спустився на платформу та пішов до локомотиву.

Голоси, що він почув у темряві, відразу ідентифікували їх власників. Говорив полковник Арбетнот:

– Мері… – Дівчина його перебила: – Не зараз, ні. Коли це все закінчиться, після всього…

Пуаро позадкував. Йому було дуже цікаво. Лунав суворий, впевнений голос міс Дебенхем.

– Цікаво, – промовив він сам до себе.

Наступного дня він зацікавився, чи вони не посварилися. Вони майже не спілкувалися, а дівчина виглядала вкрай стривожено. Під її очима з'явилися чорні кола.

О пів на третю потяг зупинився. Деякі люди повизирали з вікон. Декілька чоловіків, зібравшись разом, оглядали дещо поблизу вагона-ресторану.

''';
  }

  @override
  Widget build(BuildContext context) {
    final backgroundColor = _isDarkMode ? AppColors.darkBackground : AppColors.creamBackground;
    final textColor = _isDarkMode ? AppColors.darkText : AppColors.darkBrownText;

    return Scaffold(
      backgroundColor: backgroundColor,
      appBar: _showControls
          ? AppBar(
              backgroundColor: backgroundColor,
              foregroundColor: textColor,
              title: Text(
                widget.book.title,
                style: TextStyle(color: textColor),
              ),
              actions: [
                Text(
                  '${(_progress * 100).toStringAsFixed(0)}%',
                  style: TextStyle(color: textColor),
                ),
                const SizedBox(width: 16),
              ],
            )
          : null,
      body: GestureDetector(
        onTap: _toggleControls,
        child: SingleChildScrollView(
          controller: _scrollController,
          padding: const EdgeInsets.all(24.0),
          child: SelectableText(
            _getDemoText(),
            style: TextStyle(
              fontSize: _fontSize,
              color: textColor,
              height: 1.6,
              fontFamily: 'Georgia',
            ),
          ),
        ),
      ),
      bottomNavigationBar: _showControls
          ? Container(
              color: backgroundColor,
              padding: const EdgeInsets.all(16.0),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                children: [
                  // Темна тема
                  IconButton(
                    icon: Icon(
                      _isDarkMode ? Icons.light_mode : Icons.dark_mode,
                      color: textColor,
                    ),
                    onPressed: _toggleDarkMode,
                    tooltip: _isDarkMode ? 'Світла тема' : 'Темна тема',
                  ),
                  
                  // Зменшити шрифт
                  IconButton(
                    icon: Icon(
                      Icons.text_decrease,
                      color: textColor,
                    ),
                    onPressed: () => _changeFontSize(false),
                    tooltip: 'Зменшити шрифт',
                  ),
                  
                  // Розмір шрифту
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      color: AppColors.goldenAccent.withValues(alpha: 0.3),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Text(
                      '${_fontSize.toInt()}',
                      style: TextStyle(
                        color: textColor,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                  
                  // Збільшити шрифт
                  IconButton(
                    icon: Icon(
                      Icons.text_increase,
                      color: textColor,
                    ),
                    onPressed: () => _changeFontSize(true),
                    tooltip: 'Збільшити шрифт',
                  ),
                  
                  // Прогрес
                  IconButton(
                    icon: Icon(
                      Icons.info_outline,
                      color: textColor,
                    ),
                    onPressed: () {
                      showDialog(
                        context: context,
                        builder: (context) => AlertDialog(
                          title: const Text('Прогрес читання'),
                          content: Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              LinearProgressIndicator(
                                value: _progress,
                                backgroundColor: AppColors.lightGold,
                                color: AppColors.goldenAccent,
                              ),
                              const SizedBox(height: 16),
                              Text(
                                'Прочитано: ${(_progress * 100).toStringAsFixed(1)}%',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context),
                              child: const Text('Закрити'),
                            ),
                          ],
                        ),
                      );
                    },
                    tooltip: 'Прогрес читання',
                  ),
                ],
              ),
            )
          : null,
    );
  }
}
